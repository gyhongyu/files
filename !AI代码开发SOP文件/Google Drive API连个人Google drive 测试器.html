import React, { useState, useEffect, useRef } from 'react';

// API Key 在 Canvas 环境中会自动注入，这里留空
const API_KEY = '';
const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
const SCOPES = 'https://www.googleapis.com/auth/drive'; // 访问用户所有 Drive 文件的权限

function App() {
  const [clientId, setClientId] = useState(() => localStorage.getItem('googleDriveClientId') || '');
  const [isSignedIn, setIsSignedIn] = useState(false);
  const [files, setFiles] = useState([]);
  const [currentFolderId, setCurrentFolderId] = useState('root'); // 当前文件夹ID，默认为根目录
  const [currentFolderName, setCurrentFolderName] = useState('我的云端硬盘'); // 当前文件夹名称
  const [message, setMessage] = useState('');
  const [showModal, setShowModal] = useState(false);
  const [modalContent, setModalContent] = useState('');
  const [modalType, setModalType] = useState(''); // 'input', 'confirm'
  const [modalCallback, setModalCallback] = useState(null);
  const gapiLoaded = useRef(false);
  const gapiInitialized = useRef(false); // 新增一个ref来跟踪gapi是否已初始化

  // 动态加载 Google API 脚本
  useEffect(() => {
    if (clientId && !gapiLoaded.current) {
      const script = document.createElement('script');
      script.src = 'https://apis.google.com/js/api.js';
      script.async = true; // 异步加载
      script.defer = true; // 延迟执行

      script.onload = () => {
        // 轮询检查 gapi 是否完全可用，因为 gapi.js 可能不会立即暴露 window.gapi
        const checkGapiReady = setInterval(() => {
          if (window.gapi) {
            clearInterval(checkGapiReady);
            window.gapi.load('client:auth2', initClient);
          }
        }, 100); // 每 100 毫秒检查一次
        // 添加一个超时，防止 gapi 永远不加载的情况
        setTimeout(() => {
          if (!window.gapi && !gapiInitialized.current) { // 只有在gapi未初始化时才报错
            clearInterval(checkGapiReady);
            console.error('Google API script loaded but gapi object not found within timeout.');
            showMessage('Google API 脚本加载超时或失败，请检查网络。', true);
          }
        }, 10000); // 10 秒超时
      };
      script.onerror = () => {
        console.error('Failed to load Google API script from source.');
        showMessage('Google API 脚本加载失败，请检查网络连接。', true);
      };
      document.body.appendChild(script);
      gapiLoaded.current = true;
    }
  }, [clientId]); // 依赖 clientId，当 clientId 可用时才加载 gapi

  const initClient = () => {
    if (gapiInitialized.current) return; // 防止重复初始化
    gapiInitialized.current = true;

    window.gapi.client.init({
      apiKey: API_KEY,
      clientId: clientId, // 使用动态的 clientId
      discoveryDocs: DISCOVERY_DOCS,
      scope: SCOPES,
    }).then(() => {
      window.gapi.auth2.getAuthInstance().isSignedIn.listen(updateSignInStatus);
      updateSignInStatus(window.gapi.auth2.getAuthInstance().isSignedIn.get());
    }).catch((error) => {
      console.error('Error initializing GAPI client:', error);
      showMessage(`初始化 Google API 失败: ${error.details || error.message}`);
      gapiInitialized.current = false; // 初始化失败，重置状态
    });
  };

  const updateSignInStatus = (isSignedIn) => {
    setIsSignedIn(isSignedIn);
    if (isSignedIn) {
      listFiles(currentFolderId);
    } else {
      setFiles([]);
      showMessage('请登录 Google 账户以管理文件。');
    }
  };

  const handleSignIn = () => {
    window.gapi.auth2.getAuthInstance().signIn();
  };

  const handleSignOut = () => {
    window.gapi.auth2.getAuthInstance().signOut();
  };

  const showMessage = (msg, isError = false) => {
    setMessage(msg);
    setTimeout(() => setMessage(''), 5000); // 5秒后清除消息
  };

  const openModal = (type, content, callback) => {
    setModalType(type);
    setModalContent(content);
    setModalCallback(() => callback);
    setShowModal(true);
  };

  const closeModal = () => {
    setShowModal(false);
    setModalContent('');
    setModalType('');
    setModalCallback(null);
  };

  const handleModalSubmit = (e) => {
    e.preventDefault();
    const inputValue = e.target.elements.modalInput ? e.target.elements.modalInput.value : '';
    if (modalCallback) {
      modalCallback(inputValue);
    }
    closeModal();
  };

  const handleModalConfirm = (confirmed) => {
    if (modalCallback) {
      modalCallback(confirmed);
    }
    closeModal();
  };

  // 处理 CLIENT_ID 输入
  const handleClientIdSubmit = (e) => {
    e.preventDefault();
    const inputClientId = e.target.elements.clientIdInput.value.trim();
    if (inputClientId) {
      localStorage.setItem('googleDriveClientId', inputClientId);
      setClientId(inputClientId);
    } else {
      showMessage('CLIENT_ID 不能为空。', true);
    }
  };

  // 列出文件和文件夹
  const listFiles = async (folderId) => {
    if (!window.gapi.client || !window.gapi.client.drive) {
      showMessage('Google API 客户端未准备好。请稍候或刷新页面。', true);
      return;
    }
    try {
      showMessage('正在加载文件...');
      const response = await window.gapi.client.drive.files.list({
        pageSize: 100,
        fields: 'nextPageToken, files(id, name, mimeType, modifiedTime, size, parents)',
        q: `'${folderId}' in parents and trashed = false`, // 过滤掉已删除的文件
        orderBy: 'folder,name', // 文件夹优先，然后按名称排序
      });
      const fetchedFiles = response.result.files || [];

      // 获取当前文件夹的名称（如果不是根目录）
      if (folderId !== 'root') {
        const folderResponse = await window.gapi.client.drive.files.get({
          fileId: folderId,
          fields: 'name, parents',
        });
        setCurrentFolderName(folderResponse.result.name);
      } else {
        setCurrentFolderName('我的云端硬盘');
      }

      // 添加一个“返回上一级”的虚拟文件夹
      if (folderId !== 'root') {
        // 尝试找到当前文件夹的父级，如果找不到则回到根目录
        const parentFolderId = fetchedFiles.find(f => f.parents && f.parents.includes(folderId))?.parents[0] || 'root';
        fetchedFiles.unshift({
          id: parentFolderId,
          name: '.. (返回上一级)',
          mimeType: 'application/vnd.google-apps.folder',
          isParent: true,
        });
      }

      setFiles(fetchedFiles);
      setCurrentFolderId(folderId);
      showMessage('文件加载完成。');
    } catch (error) {
      console.error('Error listing files:', error);
      showMessage(`加载文件失败: ${error.message}`, true);
    }
  };

  // 处理文件/文件夹点击
  const handleFileClick = (file) => {
    if (file.mimeType === 'application/vnd.google-apps.folder') {
      listFiles(file.id);
    } else {
      showMessage(`点击了文件: ${file.name}`);
      // 可以添加逻辑来打开文件或提供下载链接
      // window.open(`https://drive.google.com/file/d/${file.id}/view?usp=drivesdk`, '_blank');
    }
  };

  // 上传文件
  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!window.gapi.client || !window.gapi.client.drive) {
      showMessage('Google API 客户端未准备好。请稍候或刷新页面。', true);
      return;
    }

    showMessage('正在上传文件...', false);
    const metadata = {
      name: file.name,
      parents: [currentFolderId],
    };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', file);

    try {
      const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: new Headers({ 'Authorization': 'Bearer ' + window.gapi.auth.getToken().access_token }),
        body: form,
      });

      if (!response.ok) {
        throw new Error(`文件上传失败: ${response.statusText}`);
      }

      const result = await response.json();
      showMessage(`文件 "${result.name}" 上传成功！`);
      listFiles(currentFolderId); // 刷新文件列表
    } catch (error) {
      console.error('Error uploading file:', error);
      showMessage(`文件上传失败: ${error.message}`, true);
    }
  };

  // 创建文件夹
  const handleCreateFolder = () => {
    openModal('input', '请输入新文件夹的名称:', async (folderName) => {
      if (!folderName) {
        showMessage('文件夹名称不能为空。', true);
        return;
      }

      if (!window.gapi.client || !window.gapi.client.drive) {
        showMessage('Google API 客户端未准备好。请稍候或刷新页面。', true);
        return;
      }

      showMessage('正在创建文件夹...', false);
      const fileMetadata = {
        'name': folderName,
        'mimeType': 'application/vnd.google-apps.folder',
        'parents': [currentFolderId],
      };
      try {
        const response = await window.gapi.client.drive.files.create({
          resource: fileMetadata,
          fields: 'id, name',
        });
        showMessage(`文件夹 "${response.result.name}" 创建成功！`);
        listFiles(currentFolderId); // 刷新文件列表
      } catch (error) {
        console.error('Error creating folder:', error);
        showMessage(`创建文件夹失败: ${error.message}`, true);
      }
    });
  };

  // 重命名文件/文件夹
  const handleRenameFile = (fileId, currentName) => {
    openModal('input', `请输入 "${currentName}" 的新名称:`, async (newName) => {
      if (!newName || newName === currentName) {
        showMessage('新名称无效或与旧名称相同。', true);
        return;
      }

      if (!window.gapi.client || !window.gapi.client.drive) {
        showMessage('Google API 客户端未准备好。请稍候或刷新页面。', true);
        return;
      }

      showMessage('正在重命名...', false);
      const fileMetadata = {
        name: newName,
      };
      try {
        const response = await window.gapi.client.drive.files.update({
          fileId: fileId,
          resource: fileMetadata,
          fields: 'id, name',
        });
        showMessage(`"${currentName}" 已重命名为 "${response.result.name}"！`);
        listFiles(currentFolderId); // 刷新文件列表
      } catch (error) {
        console.error('Error renaming file:', error);
        showMessage(`重命名失败: ${error.message}`, true);
      }
    });
  };

  // 删除文件/文件夹 (移至垃圾箱)
  const handleDeleteFile = (fileId, fileName) => {
    openModal('confirm', `确定要删除 "${fileName}" 吗？此操作将将其移至垃圾箱。`, async (confirmed) => {
      if (!confirmed) {
        showMessage('删除操作已取消。');
        return;
      }

      if (!window.gapi.client || !window.gapi.client.drive) {
        showMessage('Google API 客户端未准备好。请稍候或刷新页面。', true);
        return;
      }

      showMessage('正在删除...', false);
      try {
        await window.gapi.client.drive.files.update({
          fileId: fileId,
          resource: { trashed: true },
        });
        showMessage(`"${fileName}" 已成功移至垃圾箱。`);
        listFiles(currentFolderId); // 刷新文件列表
      } catch (error) {
        console.error('Error deleting file:', error);
        showMessage(`删除失败: ${error.message}`, true);
      }
    });
  };

  return (
    <div className="min-h-screen bg-gray-100 p-4 font-inter antialiased flex flex-col items-center">
      <div className="w-full max-w-4xl bg-white shadow-lg rounded-lg p-6">
        <h1 className="text-3xl font-bold text-gray-800 mb-6 text-center">Google Drive 文件管理器</h1>

        {message && (
          <div className={`p-3 mb-4 rounded-md text-sm ${message.includes('失败') ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
            {message}
          </div>
        )}

        {!clientId ? (
          <div className="flex flex-col items-center justify-center py-10">
            <p className="text-gray-600 mb-4 text-center">
              首次使用，请粘贴您的 Google Cloud Console 客户端 ID。
              <br/>
              （通常以 `.apps.googleusercontent.com` 结尾）
            </p>
            <form onSubmit={handleClientIdSubmit} className="w-full max-w-md">
              <input
                type="text"
                name="clientIdInput"
                placeholder="在此处粘贴您的 CLIENT_ID"
                className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500"
                autoFocus
              />
              <button
                type="submit"
                className="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-300"
              >
                保存 CLIENT_ID 并继续
              </button>
            </form>
          </div>
        ) : !isSignedIn ? (
          <div className="flex flex-col items-center justify-center py-10">
            <p className="text-gray-600 mb-4">请登录您的 Google 账户以开始管理文件。</p>
            <button
              onClick={handleSignIn}
              className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-300"
            >
              登录 Google
            </button>
          </div>
        ) : (
          <div>
            <div className="flex justify-between items-center mb-6 border-b pb-4">
              <h2 className="text-xl font-semibold text-gray-700">当前目录: <span className="text-blue-600">{currentFolderName}</span></h2>
              <div className="flex space-x-3">
                <label htmlFor="file-upload" className="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 cursor-pointer transition duration-300">
                  上传文件
                  <input id="file-upload" type="file" onChange={handleFileUpload} className="hidden" />
                </label>
                <button
                  onClick={handleCreateFolder}
                  className="px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition duration-300"
                >
                  创建文件夹
                </button>
                <button
                  onClick={handleSignOut}
                  className="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition duration-300"
                >
                  退出登录
                </button>
              </div>
            </div>

            {files.length === 0 ? (
              <p className="text-center text-gray-500 py-10">此文件夹中没有文件。</p>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {files.map((file) => (
                  <div
                    key={file.id}
                    className="bg-gray-50 p-4 rounded-lg shadow-sm hover:shadow-md transition duration-200 flex items-center justify-between cursor-pointer"
                    onClick={() => !file.isParent && handleFileClick(file)}
                  >
                    <div className="flex items-center flex-grow">
                      {file.mimeType === 'application/vnd.google-apps.folder' ? (
                        <svg className="w-6 h-6 text-blue-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path>
                        </svg>
                      ) : (
                        <svg className="w-6 h-6 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0113 3.414L16.586 7A2 2 0 0117 8.414V16a2 2 0 01-2 2H5a2 2 0 01-2-2V4zm5 2a1 1 0 00-1 1v3a1 1 0 002 0V7a1 1 0 00-1-1z" clipRule="evenodd"></path>
                        </svg>
                      )}
                      <span className="text-gray-800 font-medium truncate">{file.name}</span>
                    </div>
                    {!file.isParent && ( // 不对“返回上一级”操作显示按钮
                      <div className="flex space-x-2 ml-4">
                        <button
                          onClick={(e) => { e.stopPropagation(); handleRenameFile(file.id, file.name); }}
                          className="p-1 rounded-full text-blue-500 hover:bg-blue-100 transition duration-200"
                          title="重命名"
                        >
                          <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.38-2.827-2.828z"></path>
                          </svg>
                        </button>
                        <button
                          onClick={(e) => { e.stopPropagation(); handleDeleteFile(file.id, file.name); }}
                          className="p-1 rounded-full text-red-500 hover:bg-red-100 transition duration-200"
                          title="删除 (移至垃圾箱)"
                        >
                          <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clipRule="evenodd"></path>
                          </svg>
                        </button>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        )}
      </div>

      {/* 自定义模态框 */}
      {showModal && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-lg shadow-xl w-96">
            <h3 className="text-lg font-semibold mb-4">{modalContent}</h3>
            {modalType === 'input' && (
              <form onSubmit={handleModalSubmit}>
                <input
                  type="text"
                  name="modalInput"
                  className="w-full p-2 border border-gray-300 rounded-md mb-4 focus:ring-blue-500 focus:border-blue-500"
                  autoFocus
                />
                <div className="flex justify-end space-x-3">
                  <button
                    type="button"
                    onClick={closeModal}
                    className="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-200"
                  >
                    取消
                  </button>
                  <button
                    type="submit"
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200"
                  >
                    确定
                  </button>
                </div>
              </form>
            )}
            {modalType === 'confirm' && (
              <div className="flex justify-end space-x-3">
                <button
                  onClick={() => handleModalConfirm(false)}
                  className="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-200"
                >
                  取消
                </button>
                <button
                  onClick={() => handleModalConfirm(true)}
                  className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200"
                >
                  确定
                </button>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

export default App;
